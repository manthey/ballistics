<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
html,body {
  width: 100%;
  height: 100%;
  margin: 0;
}
body {
  display: flex;
  flex-direction: column;
}
#controls {
  display: flex;
  margin: 2px;
}
#filter {
  flex: 1;
  margin-left: 5px;
}
#chart {
  flex: 1;
}
  </style>
</head>
<body>
  <div id="controls">
    Filter: <input id="filter" onchange="update()"></input>
  </div>
  <div id="chart">
  </div>
  <script>
var fulldata, queryParams = getQuery();

function getQuery() {
  var query = document.location.search.replace(/(^\?)/, '').split(
    '&').map(function (n) {
    n = n.split('=');
    if (n[0]) {
      this[decodeURIComponent(n[0].replace(/\+/g, '%20'))] = decodeURIComponent(n[1].replace(/\+/g, '%20'));
    }
    return this;
  }.bind({}))[0];
  return query;
}

function setQuery(params, updateHistory) {
  Object.entries(params).forEach(([key, value]) => {
    if (value === undefined) {
      delete params[key];
    }
  });
  var newurl = window.location.protocol + '//' + window.location.host +
      window.location.pathname + '?' + Object.keys(params).map((k) => encodeURIComponent(k) + '=' + encodeURIComponent(params[k])).join('&');
  if (updateHistory) {
    window.history.pushState(params, '', newurl);
  } else {
    window.history.replaceState(params, '', newurl);
  }
}

function update() {
  queryParams.filter = document.querySelector('#filter').value;
  setQuery(queryParams, true);
  if (fulldata) {
    plot(fulldata, queryParams.filter);
  }
}

function plot(data, filter) {
  var technique = {};
  data.forEach((d) => technique[d.technique] = (technique[d.technique] || 0) + 1);
  var techlist = Object.keys(technique).sort((a, b) => technique[b] - technique[a]);
  // filter here
  if (filter) {
    data = data.filter((d) => { return eval(filter); });
  }
  var scatters = techlist.map((technique) => {
    let tidx = techlist.indexOf(technique),
        tdata = data.filter((d) => { return d.technique == technique; });
    return {
      x: tdata.map((d) => d.date_filled),
      y: tdata.map((d) => d.power_factor),
      text: tdata.map((d) => d.power_factor),
      marker: {
        symbol: tidx,
        size: 10,
        opacity: 0.5
      },
      type: 'scattergl',
      mode: 'markers',
      hoverinfo: 'text',
      showlegend: true,
      name: technique + ' (' + tdata.length + ')'
    };
  });
  var layout = {
    xaxis: {
      type: 'date',
      autorange: true
    }, 
    yaxis: {
      type: 'log', 
      autorange: true
    },
    hovermode: 'closest'
  };
  window.debug = {
    data: data,
    scatters: scatters,
    layout: layout,
    technique: technique,
    techlist: techlist
  };
  Plotly.newPlot('chart', scatters, layout);
};

if (queryParams.filter) {
  document.querySelector('#filter').value = queryParams.filter;
}

Plotly.d3.json("totallist.json", (data) => {
  fulldata = data;
  plot(fulldata, queryParams.filter);
});
  </script>  
</body>
